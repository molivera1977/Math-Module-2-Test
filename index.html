<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Module 2 ‚Äì Online Test</title>
  <style>
    body { font-family: "Comic Sans MS","Comic Neue",Arial,sans-serif; background:#f0f8ff; margin:0; padding:0; }
    header { background:linear-gradient(90deg,#0074d9,#39c0ed); color:#fff; padding:1.2rem; text-align:center; font-size:1.6rem; font-weight:bold; }
    .container { max-width:900px; margin:2rem auto; background:#fff; padding:2rem; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,.2); }
    .hidden { display:none; }
    button { background:#0074d9; color:#fff; border:none; padding:10px 15px; margin:8px; border-radius:8px; cursor:pointer; font-size:1rem; transition:background .2s; }
    button:hover { background:#005fa3; }
    .label { font-weight:bold; display:block; margin-bottom:.3rem; }
    input { padding:10px; border:1px solid #ccc; border-radius:8px; font-size:1rem; width:100%; }
    .center { text-align:center; }
    .progress { font-weight:bold; margin-bottom:.3rem; }
    .progress-bar-container { background:#e0e0e0; border-radius:10px; overflow:hidden; height:18px; margin-bottom:1rem; }
    .progress-bar { background:linear-gradient(90deg,#39c0ed,#28a745); height:100%; width:0%; transition:width .4s ease; }
    #answers button { display:block; width:100%; text-align:left; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:.95rem; }
    th,td { border:1px solid #ddd; padding:8px; }
    th { background:#f7f7f7; }
    #confetti-canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
  </style>
</head>
<body>
  <header>üß™ Math Module 2 ‚Äì Online Test</header>
  <canvas id="confetti-canvas"></canvas>

  <div class="container" id="start-screen">
    <h2>Student Info</h2>
    <label class="label" for="student-name">Student Name</label>
    <input id="student-name" placeholder="First Last" />
    <div class="center" style="margin-top:1.2rem;">
      <button onclick="startTest('A')">Start Form A</button>
      <button onclick="startTest('B')">Start Form B</button>
    </div>
    <div class="center" style="margin-top:1rem;">
      <button id="teacher-btn" title="Password required">üîê Teacher Mode</button>
    </div>
    <p class="center" style="font-size:.9rem;color:#444;margin-top:.5rem;">Answers are hidden until submission. Progress saves only when you press Next.</p>
  </div>

  <div class="container hidden" id="quiz-screen">
    <div class="progress" id="progress"></div>
    <div class="progress-bar-container"><div class="progress-bar" id="progress-bar"></div></div>
    <div class="center" style="margin:.5rem 0;"><span id="meta-name"></span> ‚Ä¢ <span id="meta-form"></span></div>
    <h2 id="question-text"></h2>
    <div id="answers"></div>
    <div class="center" style="margin-top:1rem;">
      <button id="next-btn" class="hidden" onclick="nextQuestion()">Next ‚û°Ô∏è</button>
      <button id="submit-btn" class="hidden" onclick="submitTest()">Submit Test ‚úÖ</button>
    </div>
  </div>

  <div class="container hidden" id="end-screen">
    <h2>üéâ Test Submitted!</h2>
    <p id="final-score" class="score"></p>
    <p id="percent-score" class="score"></p>
    <p id="performance-message" class="message"></p>
    <div class="center"><button onclick="restart()">üîÑ New Student</button></div>
  </div>

  <div class="container hidden" id="teacher-screen">
    <h2>üìä Teacher Dashboard <span style="font-size:.9rem;color:#444;">(newest first)</span></h2>
    <div style="margin-bottom:.5rem;">
      <button onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
      <button onclick="backToStart()">‚Ü©Ô∏è Exit</button>
    </div>
    <table id="results-table">
      <thead><tr><th>Timestamp</th><th>Name</th><th>Form</th><th>Score</th><th>Percent</th><th>Answered</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Live Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDVt6A-01-nI1nGp5Dslv9gkb6LpQp6wgI",
      authDomain: "math-module-2-test.firebaseapp.com",
      projectId: "math-module-2-test",
      storageBucket: "math-module-2-test.appspot.com",
      messagingSenderId: "829053501307",
      appId: "1:829053501307:web:cbad37685920e3a9de07de",
      measurementId: "G-8JKB2KT435"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TEACHER_PASSWORD = "Chumley19771986!";

    // EXACT question sets from your Review
    const tests = {
      A: [
        {q:"What is the sum of 46,359 + 1,273?", options:["47,522","47,632","58,089","59,089"], answer:"47,632"},
        {q:"How much greater is 579,611 than 185,105?", options:["394,506","394,516","405,494","414,514"], answer:"394,516"},
        {q:"A rectangle has a length of 7 meters and a width of 3 meters. What is the perimeter of the rectangle in meters?", options:["10","20","21","42"], answer:"20"},
        {q:"The width of a field is 14 yards, and the length is 3 yards longer than the width. What is the perimeter of the field in yards?", options:["17","34","42","62"], answer:"34"},
        {q:"What is the difference between 682,741 and 95,126?", options:["587,605","587,615","597,615","587,516"], answer:"587,615"},
        {q:"What is the sum of 7,218 and 32,849?", options:["39,057","39,067","40,067","41,067"], answer:"40,067"},
        {q:"Zahra's square garden has sides that each measure 7 feet. How many feet of fencing will she need to go all the way around her garden?", options:["14","21","28","49"], answer:"28"},
        {q:"Bailey wrote the number 187,296, and Alex wrote the number 592,479. What is the estimated sum of their numbers when each is rounded to the nearest hundred thousand?", options:["700,000","800,000","900,000","1,000,000"], answer:"800,000"},
        {q:"A rectangle is 8 inches long and 4 inches wide. What is its perimeter?", options:["12 inches","16 inches","20 inches","24 inches"], answer:"24 inches"},
        {q:"The total fair attendance last year was 162,573 people. This year, 159,865 people attended. How many fewer people attended this year than last year?", options:["2,608","2,708","2,808","2,908"], answer:"2,708"},
        {q:"Arnold has a rectangular rug that is 5 feet long and 3 feet wide. What is the perimeter of the rug?", options:["12 ft","14 ft","15 ft","16 ft"], answer:"16 ft"},
        {q:"A female white rhinoceros weighs 3,981 pounds. A male white rhinoceros weighs 5,032 pounds. How many more pounds does the male weigh than the female?", options:["1,041","1,051","1,061","1,071"], answer:"1,051"},
        {q:"James has a goal of reading 3,250 pages. He reads 384 pages the first month. James writes the expression 3,300 - 400 to estimate how many more pages he needs to read. Is his estimate reasonable?", options:["No, he should have rounded 3,250 to 3,200 instead.","No, he should have subtracted from 3,300 instead of adding.","Yes, he correctly rounded each number to the nearest hundred.","Yes, he correctly rounded each number to the nearest thousand."], answer:"Yes, he correctly rounded each number to the nearest hundred."},
        {q:"James has read 384 of his 3,250 pages. How many pages does he have left to reach his goal?", options:["2,856","2,866","2,876","2,886"], answer:"2,866"}
      ],
      B: [
        {q:"What is the sum of 23,187 + 1,596?", options:["39,147","38,047","24,783","24,673"], answer:"24,783"},
        {q:"How much greater is 716,524 than 381,205?", options:["335,319","335,329","464,681","475,321"], answer:"335,329"},
        {q:"The width of a rectangle is 5 meters and the length is 12 meters. What is the perimeter of the rectangle in meters?", options:["17","34","60","120"], answer:"34"},
        {q:"The width of a park is 25 yards, and the length is 15 yards longer than the width. What is the perimeter of the park in yards?", options:["40","80","130","160"], answer:"80"},
        {q:"What is the difference between 213,864 and 64,237?", options:["149,617","149,627","149,637","149,647"], answer:"149,627"},
        {q:"What is the sum of 6,519 and 53,724?", options:["60,233","60,243","60,253","60,263"], answer:"60,243"},
        {q:"Raymond makes a square art design with each side 6 inches long. How many inches of ribbon will he need to go around it?", options:["12","18","24","36"], answer:"24"},
        {q:"Kelley wrote 613,794 and Jayson wrote 297,658. What is the estimated sum of their numbers when each is rounded to the nearest hundred thousand?", options:["700,000","800,000","900,000","1,000,000"], answer:"900,000"},
        {q:"A rectangle is 12 inches long and 6 inches wide. What is the perimeter?", options:["18","24","30","36"], answer:"36"},
        {q:"A recycling center received 183,762 pounds of materials last month and 188,135 pounds this month. How many fewer pounds were received last month than this month?", options:["4,353","4,363","4,373","4,383"], answer:"4,373"},
        {q:"Carmen bought a rectangular painting that measures 7 feet long and 4 feet wide. What is the perimeter of the painting?", options:["18 ft","20 ft","22 ft","24 ft"], answer:"22 ft"},
        {q:"A theater has 2,791 seats. An auditorium has 2,477 seats. How many more seats does the theater have than the auditorium?", options:["314","324","334","344"], answer:"314"},
        {q:"A truck driver has a 1,256-mile route to complete. She travels 437 miles the first day. She writes the expression 1,300 - 400 to estimate how many miles remain. Is her estimate reasonable?", options:["No, she should have rounded 1,256 to 1,200 instead.","No, she should have subtracted from 1,300 instead of adding.","Yes, she correctly rounded each number to the nearest ten.","Yes, she correctly rounded each number to the nearest hundred."], answer:"Yes, she correctly rounded each number to the nearest hundred."},
        {q:"A truck driver has a 1,256-mile route and has already traveled 437 miles. How many miles are left to travel?", options:["809","819","829","839"], answer:"819"}
      ]
    };

    // App state
    let currentTest = [];
    let currentIndex = 0;
    let selections = [];
    let docRefId = null;
    let meta = { name: "", form: "" };

    function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
    function updateProgress(){ document.getElementById("progress").innerText = `Question ${currentIndex+1} of ${currentTest.length}`; document.getElementById("progress-bar").style.width = (currentIndex/currentTest.length*100) + "%"; }

    // Start test
    window.startTest = async function(form){
      const name = document.getElementById("student-name").value.trim();
      if(!name){ alert("Please enter your name."); return; }
      meta = { name, form };
      document.getElementById("meta-name").innerText = name;
      document.getElementById("meta-form").innerText = "Form " + form;

      currentTest = shuffle(JSON.parse(JSON.stringify(tests[form])));
      currentTest = currentTest.map(q => ({ ...q, options: shuffle(q.options) }));
      currentIndex = 0;
      selections = new Array(currentTest.length).fill(null);

      // Create attempt
      const newDoc = await addDoc(collection(db,"math_module_2_attempts"),{
        name, form, total: currentTest.length, answered: 0, score: 0, percent: 0, responses: [],
        startedAt: serverTimestamp(), updatedAt: serverTimestamp()
      });
      docRefId = newDoc.id;

      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("quiz-screen").classList.remove("hidden");
      showQuestion();
    };

    function showQuestion(){
      const qObj = currentTest[currentIndex];
      updateProgress();
      document.getElementById("question-text").innerText = qObj.q;
      const answersDiv = document.getElementById("answers");
      answersDiv.innerHTML = "";
      qObj.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.innerText = opt;
        btn.onclick = () => {
          // Visual highlight only (green); no Firestore write yet
          Array.from(answersDiv.children).forEach(b => { b.style.background="#0074d9"; b.style.color="white"; });
          btn.style.background = "#28a745";
          btn.style.color = "white";
          selections[currentIndex] = opt;
          // Show Next button once selection made
          document.getElementById("next-btn").classList.remove("hidden");
          if (currentIndex === currentTest.length - 1) {
            document.getElementById("submit-btn").classList.remove("hidden");
          }
        };
        answersDiv.appendChild(btn);
      });
      // Reset controls
      document.getElementById("next-btn").classList.add("hidden");
      document.getElementById("submit-btn").classList.add("hidden");
    }

    window.nextQuestion = async function(){
      if (selections[currentIndex] === null) {
        alert("Please select an answer before continuing.");
        return;
      }
      // Write progress only on Next
      await updateDoc(doc(db,"math_module_2_attempts",docRefId),{
        responses: selections,
        answered: selections.filter(x => x !== null).length,
        updatedAt: serverTimestamp()
      });
      currentIndex++;
      if (currentIndex < currentTest.length) {
        showQuestion();
      } else {
        document.getElementById("next-btn").classList.add("hidden");
        document.getElementById("submit-btn").classList.remove("hidden");
      }
    };

    window.submitTest = async function(){
      const score = currentTest.reduce((acc,q,i)=> acc + (selections[i]===q.answer ? 1 : 0), 0);
      const percent = Math.round((score/currentTest.length)*100);
      await updateDoc(doc(db,"math_module_2_attempts",docRefId),{
        score, percent, finishedAt: serverTimestamp(), updatedAt: serverTimestamp()
      });

      // End UI
      document.getElementById("quiz-screen").classList.add("hidden");
      document.getElementById("end-screen").classList.remove("hidden");
      document.getElementById("final-score").innerText = `You scored ${score} out of ${currentTest.length}.`;
      document.getElementById("percent-score").innerText = `That‚Äôs ${percent}%.`;
      let message = percent===100 ? "üåü Excellent work! Perfect score!" :
                    percent>=80 ? "üëç Great job! You really know this material." :
                    percent>=70 ? "üëè Nice job ‚Äî you passed!" :
                    percent>=60 ? "üëå Not bad! Keep practicing to improve." :
                                  "üí° Keep trying! Review the lessons and practice again.";
      document.getElementById("performance-message").innerText = message;

      // Confetti only if >= 70%, for 3 seconds
      if (percent >= 70) {
        const duration = 3000;
        const end = Date.now() + duration;
        (function frame() {
          confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
          confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      }
    };

    // Teacher Mode (simple, newest-first live table)
    document.getElementById("teacher-btn").addEventListener("click", ()=>{
      const pw = prompt("Enter Teacher Password");
      if (pw !== TEACHER_PASSWORD) { alert("Incorrect password."); return; }
      showTeacher();
    });

    function showTeacher(){
      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("teacher-screen").classList.remove("hidden");
      const qLatest = query(collection(db,"math_module_2_attempts"), orderBy("updatedAt","desc"));
      onSnapshot(qLatest, snap => {
        const tbody = document.querySelector("#results-table tbody");
        tbody.innerHTML = "";
        snap.forEach(d => {
          const v = d.data();
          const answered = (v.responses || []).filter(x => x !== null).length;
          const ts = v.updatedAt?.toDate ? v.updatedAt.toDate() : new Date();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${ts.toLocaleString()}</td><td>${v.name||""}</td><td>${v.form||""}</td><td>${v.score??""}/${v.total??""}</td><td>${v.percent??""}%</td><td>${answered}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    window.backToStart = function(){
      document.getElementById("teacher-screen").classList.add("hidden");
      document.getElementById("start-screen").classList.remove("hidden");
    };

    window.exportCSV = function(){
      // Optional ‚Äî easily added later
      alert("Export CSV coming soon in this build. Use the previous dashboard build if needed.");
    };

    window.restart = function(){
      document.getElementById("end-screen").classList.add("hidden");
      document.getElementById("start-screen").classList.remove("hidden");
      document.getElementById("student-name").value = "";
      document.getElementById("progress-bar").style.width = "0%";
    };
  </script>
</body>
</html>
